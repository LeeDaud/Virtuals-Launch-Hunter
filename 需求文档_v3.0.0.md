# 需求文档 V3.0.0（给 Codex/开发者）

> 目标：让其他人把这份文档交给 Codex 后，能够复现一个功能等价的程序。

## 1. 项目定位
- 产品名：`V-Pulse 盘面雷达`
- 场景：监控 Base 链某类内盘/打新交易，给出实时看板与历史回扫分析。
- 核心原则：
  - 热路径不使用 Supabase。
  - 本地 SQLite 持久化。
  - 支持实时与回扫并行，互补补漏。

## 2. 必须满足的业务目标
1. 在 UI 中看到实时新增交易，不依赖手动刷新回扫。
2. 支持按 UTC+8 时间区间手动回扫。
3. 同时展示：
   - 分钟消耗（SpentV）
   - 大户榜
   - 我的钱包持仓
   - 交易录入延迟
4. 项目配置支持在 UI 修改并持久化。
5. 监控钱包支持在 UI 增删并持久化。
6. 回扫任务可取消。

## 3. 架构约束
- 语言：Python
- 后端框架：`aiohttp`
- 数据库：SQLite
- 前端：单文件 `dashboard.html`（原生 JS/CSS）
- 运行角色：
  - `writer`
  - `realtime`
  - `backfill`
  - `all`（兼容单进程）
- 三进程模式下：
  - `realtime` 与 `backfill` 通过事件总线库写事件
  - `writer` 独占主库写入

## 4. 数据来源与解析规则

### 4.1 链上数据源
- 实时：WS 订阅区块或日志
- 回扫：HTTP `eth_getLogs`
- 交易回执：`eth_getTransactionReceipt`
- 区块时间：`eth_getBlockByNumber`
- 链上价格：`eth_call` 读取池子储备

### 4.2 关键过滤
- 只处理与 `internal_pool_addr` 相关的目标交易。
- 不放宽 swap 判定规则（保持严格，避免误识别）。
- 买家地址定义为：交易哈希内，与内盘交互后目标代币的最终流向地址。

## 5. 主要功能清单

### 5.1 项目管理
- 字段：`name`、`internal_pool_addr`
- 固定字段（不在 UI 编辑）：`fee_addr`、`tax_addr`、`fee_rate`、`token_total_supply`
- 支持新增/切换/删除项目
- 支持“仅监控当前项目”

### 5.2 钱包管理
- UI 支持新增监控钱包
- UI 支持删除监控钱包
- 支持按“当前项目 + 单钱包”重算历史

### 5.3 统计与榜单
- 分钟消耗：按交易时间桶（分钟）累计 `spent_v_actual`
- 大户榜排序：按累计买入代币数量降序
- 我的钱包：按项目维度展示持仓和累计消耗

### 5.4 回扫
- 自动回扫：周期循环补漏
- 手动回扫：UTC+8 区间触发
- 去重：已入库 tx hash 不重复插入
- 回扫任务支持取消

### 5.5 实时观感
- UI 固定节奏刷新
- 刷新按钮有明确反馈
- 关键数字支持悬浮查看精确值（不闪烁）

## 6. API 需求
- `GET /`：返回 dashboard
- `GET /health`：健康状态
- `GET /meta`：元数据（项目、钱包、运行参数）
- `GET /leaderboard`：大户榜
- `GET /minutes`：分钟消耗
- `GET /mywallets`：我的钱包汇总
- `GET /event-delays`：录入延迟
- `POST /launch-configs`：保存/切换项目
- `DELETE /launch-configs/{name}`：删除项目
- `GET /wallet-configs`：监控钱包列表
- `POST /wallet-configs`：新增监控钱包
- `DELETE /wallet-configs/{wallet}`：删除监控钱包
- `POST /wallet-recalc`：按项目+钱包重算
- `POST /scan-range`：创建回扫任务
- `GET /scan-jobs/{job_id}`：查询任务进度
- `POST /scan-jobs/{job_id}/cancel`：取消任务

## 7. 配置需求（config.json）
- 节点：
  - `WS_RPC_URL`
  - `HTTP_RPC_URL`
  - `BACKFILL_HTTP_RPC_URL`
- 项目与钱包：
  - `LAUNCH_CONFIGS`
  - `MY_WALLETS`
- 性能参数：
  - `CONFIRMATIONS`
  - `BACKFILL_CHUNK_BLOCKS`
  - `BACKFILL_INTERVAL_SEC`
  - `RECEIPT_WORKERS_REALTIME`
  - `RECEIPT_WORKERS_BACKFILL`
  - `DB_BATCH_SIZE`
  - `DB_FLUSH_MS`
- 数据路径：
  - `SQLITE_PATH`
  - `EVENT_BUS_SQLITE_PATH`
  - `JSONL_PATH`

## 8. UI 需求
- 主题：暗色专业仪表盘
- 顶部：项目选择、回扫区间、刷新按钮、状态提示
- KPI：连接状态、价格、队列/待处理、解析/入库
- 图表：分钟消耗柱状图（显示时间刻度）
- 列表：大户榜、我的钱包、录入延迟
- 交互：
  - 地址和 tx hash 一键复制
  - 按钮反馈（进行中/成功/失败）
  - Tooltip 稳定不闪烁

## 9. 非功能要求
- 目标延迟：日常 1~3 秒，高峰 5~12 秒可接受
- 稳定性：单进程异常不应破坏数据库一致性
- 可维护：日志可读，关键状态可观测
- 隐私：不在仓库提交 API Key

## 10. 验收标准
1. 启动三进程后，UI 30 秒内可用。
2. 实时有新交易时，UI 可见数据变化。
3. 手动回扫后，统计与榜单同步更新。
4. 同一 tx hash 不重复入库。
5. 新增/删除项目、钱包可持久化。
6. 回扫任务可取消，状态正确反馈。

## 11. 建议给 Codex 的执行指令模板
```
请基于本需求文档实现 V-Pulse 盘面雷达（V3.0.0）：
1) Python + aiohttp + SQLite
2) 支持 writer/realtime/backfill/all 四种角色
3) 提供 dashboard.html 单页 UI
4) 实现文档中列出的 API、回扫、钱包重算、项目管理
5) 输出完整可运行项目结构与 config.example.json
6) 保证不使用 Supabase 热路径
```